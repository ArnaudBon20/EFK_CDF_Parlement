// Variables used by Scriptable.
// These must be at the very top of the file. Do not edit.
// icon-color: red; icon-glyph: file-alt;

/**
 * Widget Curia Vista - Interpellations mentionnant CDF/EFK
 * Affichage:
 *  - ligne 1: titre
 *  - ligne 2: numéros des nouvelles interpellations (depuis la dernière mise à jour quotidienne), sinon ❌
 *  - puis: les 3 dernières (numéros uniquement)
 * Click -> ouvre la recherche Curia Vista
 */

const UPDATE_HOUR = 0;
const UPDATE_MINUTE = 30;

// --- Config FR/DE ---
const CFG = {
  fr: {
    title: "Le CDF au Parlement",
    url: 'https://www.parlament.ch/fr/ratsbetrieb/suche-curia-vista#k=%22Contr%C3%B4le%20f%C3%A9d%C3%A9ral%20des%20finances%22',
    acceptLang: "fr-CH,fr;q=0.9",
  },
  de: {
    title: "Die EFK im Parlament",
    url: 'https://www.parlament.ch/de/ratsbetrieb/suche-curia-vista#k=%22Eidgen%C3%B6ssische%20Finanzkontrolle%22#l=1033',
    acceptLang: "de-CH,de;q=0.9",
  },
};

// --- Utils ---
function decodeHtmlEntities(str) {
  if (!str) return "";
  return String(str)
    .replace(/&nbsp;/gi, " ")
    .replace(/&amp;/gi, "&")
    .replace(/&quot;/gi, '"')
    .replace(/&#039;/gi, "'")
    .replace(/&lt;/gi, "<")
    .replace(/&gt;/gi, ">")
    .replace(/&#(\d+);/g, (_, code) => {
      try { return String.fromCharCode(parseInt(code, 10)); } catch { return _; }
    })
    .replace(/[’‘‛]/g, "'")
    .trim();
}

function pickLang() {
  // 1) widgetParameter a priorité
  const p = (args.widgetParameter || "").trim().toLowerCase();
  if (p === "fr" || p === "de") return p;

  // 2) langue d’interface (corrige le cas iPhone de_CH -> allemand)
  // Device.language() renvoie typiquement "fr", "de", "it", ...
  const ui = (Device.language() || "").toLowerCase();
  if (ui.startsWith("de")) return "de";
  return "fr";
}

function nowISO() { return new Date().toISOString(); }

// --- Fetcher / Cache ---
class CuriaVistaFetcher {
  constructor(cfg, key) {
    this.cfg = cfg;
    this.key = key;
    this.fm = FileManager.local();
    this.dir = this.fm.joinPath(this.fm.documentsDirectory(), "cdf-efk-curiavista");
    if (!this.fm.fileExists(this.dir)) this.fm.createDirectory(this.dir, true);

    this.cacheNumsPath = this.fm.joinPath(this.dir, `cacheNums_${key}.json`);
    this.lastUpdatePath = this.fm.joinPath(this.dir, `lastUpdate_${key}.txt`);
    this.seenPath = this.fm.joinPath(this.dir, `seen_${key}.json`);
    this.lastNewPath = this.fm.joinPath(this.dir, `lastNew_${key}.json`);
  }

  loadJSON(path, fallback) {
    if (!this.fm.fileExists(path)) return fallback;
    try { return JSON.parse(this.fm.readString(path)); } catch { return fallback; }
  }

  saveJSON(path, obj) {
    try { this.fm.writeString(path, JSON.stringify(obj)); return true; } catch { return false; }
  }

  getLastUpdateDate() {
    if (!this.fm.fileExists(this.lastUpdatePath)) return new Date(0);
    try { return new Date(this.fm.readString(this.lastUpdatePath)); } catch { return new Date(0); }
  }

  shouldUpdate() {
    const now = new Date();
    const lastUpdate = this.getLastUpdateDate();
    const todayUpdate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), UPDATE_HOUR, UPDATE_MINUTE);

    if (!this.fm.fileExists(this.cacheNumsPath)) return true;
    if (now >= todayUpdate && lastUpdate < todayUpdate) return true;

    return false;
  }

  async fetchHTML() {
    const req = new Request(this.cfg.url);
    req.headers = {
      "User-Agent": "Mozilla/5.0 (iPhone; CPU iPhone OS 16_0 like Mac OS X) AppleWebKit/605.1.15",
      "Accept-Language": this.cfg.acceptLang,
    };
    return await req.loadString();
  }

  parseInterpellationNumbers(html) {
    const out = [];
    if (!html) return out;

    // numéros type 24.1234
    const numRe = /\b(\d{2}\.\d{4})\b/g;
    const matches = [...html.matchAll(numRe)];
    if (matches.length === 0) return out;

    for (const m of matches) {
      const num = m[1];
      const idx = m.index ?? -1;
      if (idx < 0) continue;

      // petite fenêtre autour pour vérifier le type "Interpellation"
      const start = Math.max(0, idx - 600);
      const end = Math.min(html.length, idx + 600);
      const snippet = decodeHtmlEntities(html.slice(start, end)).toLowerCase();

      if (snippet.includes("interpellation")) {
        if (!out.includes(num)) out.push(num);
      }
    }
    return out;
  }

  loadNumsCache() { return this.loadJSON(this.cacheNumsPath, []); }
  loadSeen() { return this.loadJSON(this.seenPath, []); }
  saveSeen(arr) { this.saveJSON(this.seenPath, arr); }

  loadLastNew() { return this.loadJSON(this.lastNewPath, []); }
  saveLastNew(arr) { this.saveJSON(this.lastNewPath, arr); }

  async getNumsAndMaybeUpdate() {
    const cached = this.loadNumsCache();

    if (!this.shouldUpdate()) {
      return { nums: cached, didUpdate: false };
    }

    try {
      const html = await this.fetchHTML();
      const nums = this.parseInterpellationNumbers(html);

      if (nums.length > 0) {
        this.saveJSON(this.cacheNumsPath, nums);
        this.fm.writeString(this.lastUpdatePath, nowISO());
        return { nums, didUpdate: true };
      }

      // fallback
      return { nums: cached, didUpdate: false };
    } catch (e) {
      console.error("fetch error:", e);
      return { nums: cached, didUpdate: false };
    }
  }
}

// --- UI helpers ---
function addTitle(w, cfg) {
  const t = w.addText(cfg.title);
  t.font = Font.boldSystemFont(14);
}

function addLine(w, text, bold = false) {
  const t = w.addText(text);
  t.font = bold ? Font.boldSystemFont(12) : Font.systemFont(12);
  t.lineLimit = 1;
}

// --- Main ---
const lang = pickLang();
const cfg = CFG[lang];

const fetcher = new CuriaVistaFetcher(cfg, lang);
const { nums: allNums, didUpdate } = await fetcher.getNumsAndMaybeUpdate();

// Calcul des nouveautés uniquement quand on a vraiment mis à jour (comparé à “hier”)
let newNumsToShow = fetcher.loadLastNew();

if (didUpdate) {
  const seen = fetcher.loadSeen();
  const newNums = allNums.filter((n) => !seen.includes(n));

  // stocke pour affichage jusqu’à la prochaine mise à jour
  fetcher.saveLastNew(newNums);

  // met à jour le "seen" uniquement lors de la vraie mise à jour
  fetcher.saveSeen(allNums);

  newNumsToShow = newNums;
}

// 3 dernières
const last3 = (allNums || []).slice(0, 3);

// Widget
const w = new ListWidget();
w.url = cfg.url;
w.setPadding(12, 12, 12, 12);

addTitle(w, cfg);
w.addSpacer(6);

// Ligne nouveautés: numéros sur une ligne sinon ❌
if (newNumsToShow && newNumsToShow.length > 0) {
  addLine(w, newNumsToShow.join(" / "), true);
} else {
  addLine(w, "❌", true);
}

w.addSpacer(6);

// 3 dernières
if (last3.length === 0) {
  addLine(w, "—");
} else {
  for (const n of last3) addLine(w, n);
}

Script.setWidget(w);
Script.complete();
