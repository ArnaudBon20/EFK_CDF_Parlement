// Variables used by Scriptable.
// These must be at the very top of the file. Do not edit.
// icon-color: red; icon-glyph: file-alt;

/**
 * Le CDF/EFK au Parlement – Interpellations mentionnant le CDF/EFK
 * - Langue auto selon iOS (preferredLanguages -> language -> locale)
 * - Data via ws-old.parlament.ch (évite le HTML Curia Vista dynamique)
 * - Affichage:
 *    1) Titre centré
 *    2) Nouveautés (numéros sur 1 ligne) ou ❌
 *    3) 3 dernières: numéro — titre + "NOM (Parti)" si possible
 * - Tap: ouvre la recherche Curia Vista (parlament.ch)
 */

const UPDATE_HOUR = 0;
const UPDATE_MINUTE = 30;

const CFG = {
  fr: {
    title: "Le CDF au Parlement",
    curiaUrl:
      'https://www.parlament.ch/fr/ratsbetrieb/suche-curia-vista#k=%22Contr%C3%B4le%20f%C3%A9d%C3%A9ral%20des%20finances%22',
    searchText: "Contrôle fédéral des finances",
    langParam: "fr",
    typeNeedle: "interpellation", // pour matcher "Interpellation" en FR
  },
  de: {
    title: "Die EFK im Parlament",
    curiaUrl:
      'https://www.parlament.ch/de/ratsbetrieb/suche-curia-vista#k=%22Eidgen%C3%B6ssische%20Finanzkontrolle%22#l=1033',
    searchText: "Eidgenössische Finanzkontrolle",
    langParam: "de",
    typeNeedle: "interpellation", // en DE aussi "Interpellation"
  },
};

// ----------------- Lang auto (robuste) -----------------
function pickLangAuto() {
  try {
    if (Device.preferredLanguages) {
      const prefs = Device.preferredLanguages() || [];
      const first = prefs.map((x) => String(x).toLowerCase());
      if (first.find((x) => x.startsWith("fr"))) return "fr";
      if (first.find((x) => x.startsWith("de"))) return "de";
    }
  } catch (_) {}

  const lang = String(Device.language() || "").toLowerCase();
  if (lang.startsWith("fr")) return "fr";
  if (lang.startsWith("de")) return "de";

  const loc = String(Device.locale() || "").toLowerCase(); // ex: fr_CH / de_CH
  if (loc.startsWith("fr")) return "fr";
  if (loc.startsWith("de")) return "de";

  return "fr";
}

// ----------------- Cache -----------------
const fm = FileManager.local();
const dir = fm.joinPath(fm.documentsDirectory(), "cdf-efk-curiavista");
if (!fm.fileExists(dir)) fm.createDirectory(dir, true);

function p(name) {
  return fm.joinPath(dir, name);
}
function loadJSON(path, fallback) {
  try {
    if (!fm.fileExists(path)) return fallback;
    return JSON.parse(fm.readString(path));
  } catch {
    return fallback;
  }
}
function saveJSON(path, obj) {
  fm.writeString(path, JSON.stringify(obj));
}
function loadString(path, fallback = "") {
  try {
    if (!fm.fileExists(path)) return fallback;
    return fm.readString(path);
  } catch {
    return fallback;
  }
}
function saveString(path, s) {
  fm.writeString(path, String(s));
}

function nowISO() {
  return new Date().toISOString();
}
function shouldUpdate(lastUpdateISO) {
  const now = new Date();
  const last = lastUpdateISO ? new Date(lastUpdateISO) : new Date(0);
  const todayUpdate = new Date(
    now.getFullYear(),
    now.getMonth(),
    now.getDate(),
    UPDATE_HOUR,
    UPDATE_MINUTE
  );

  // pas de cache -> update
  if (!lastUpdateISO) return true;

  // update 1x/jour après l'heure choisie
  if (now >= todayUpdate && last < todayUpdate) return true;

  return false;
}

// ----------------- Helpers texte -----------------
function normalizeSpace(s) {
  return String(s || "")
    .replace(/\s+/g, " ")
    .trim();
}
function clamp(s, max) {
  const x = String(s || "");
  if (x.length <= max) return x;
  return x.slice(0, Math.max(0, max - 1)).trimEnd() + "…";
}

// "Nom (Parti)" à partir des infos councillor/party de l’API
function formatSurnamePartyFromAffair(affair) {
  try {
    const c = affair?.author?.councillor;
    if (!c) return "";

    const lastName = normalizeSpace(c.lastName || c.lastname || c.name || "");
    // Party: selon les objets, ça peut être party.abbreviation OU party.name
    const party =
      normalizeSpace(affair?.author?.party?.abbreviation) ||
      normalizeSpace(affair?.author?.party?.name) ||
      normalizeSpace(c?.party?.abbreviation) ||
      normalizeSpace(c?.party?.name) ||
      "";

    if (lastName && party) return `${lastName} (${party})`;
    return lastName || "";
  } catch {
    return "";
  }
}

// ----------------- Fetch via ws-old -----------------
async function httpGetJSON(url) {
  const req = new Request(url);
  req.method = "GET";
  // ws-old accepte ?format=json
  return await req.loadJSON();
}

/**
 * 1) recherche ids via /affairs?searchTextFilter=...
 * 2) pour les ids récents, fetch détails /affairs/<id>...
 * 3) filtre type = interpellation
 * 4) garde top N (par updated desc)
 */
async function fetchInterpellations(cfg) {
  // Résultats "liste": typiquement [{id, updated, shortId, hasMorePages?}, ...]
  const listUrl =
    `https://ws-old.parlament.ch/affairs?format=json` +
    `&lang=${encodeURIComponent(cfg.langParam)}` +
    `&pageNumber=1` +
    `&searchTextFilter=${encodeURIComponent(cfg.searchText)}`;

  const list = await httpGetJSON(listUrl);

  // Sécurise: ne traite que les premiers 50 IDs
  const ids = (Array.isArray(list) ? list : [])
    .map((x) => x?.id)
    .filter(Boolean)
    .slice(0, 50);

  const details = [];
  for (const id of ids) {
    try {
      const d = await httpGetJSON(
        `https://ws-old.parlament.ch/affairs/${id}?format=json&lang=${encodeURIComponent(
          cfg.langParam
        )}`
      );

      const typeName = normalizeSpace(d?.type?.name || d?.typeName || "");
      if (!typeName.toLowerCase().includes(cfg.typeNeedle)) continue;

      // numéro (shortId) : souvent d.shortId, sinon "id" n'est pas le format 24.1234
      const num = normalizeSpace(d?.shortId || d?.shortID || "");

      // titre
      const title = normalizeSpace(d?.title || d?.titles?.[0]?.value || "");

      // auteur NOM (Parti)
      const author = formatSurnamePartyFromAffair(d);

      // date de maj (pour trier)
      const updated = d?.updated || "";

      // lien affaire sur parlament.ch (détails Curia Vista)
      const affairLink =
        (d?.links && d.links.find((l) => (l?.url || "").includes("parlament.ch"))?.url) ||
        (num
          ? `https://www.parlament.ch/${cfg.langParam}/ratsbetrieb/suche-curia-vista/geschaeft?AffairId=${encodeURIComponent(
              String(id)
            )}`
          : "");

      details.push({ id, num, title, author, updated, affairLink });
    } catch (_) {
      // ignore
    }
  }

  // tri: updated desc
  details.sort((a, b) => String(b.updated).localeCompare(String(a.updated)));

  return details;
}

// ----------------- UI -----------------
function addCenteredTitle(w, text) {
  const t = w.addText(text);
  t.font = Font.boldSystemFont(14);
  t.centerAlignText();
}
function addLine(w, text, opts = {}) {
  const {
    bold = false,
    centered = false,
    size = 12,
    color = null,
    lineLimit = 1,
  } = opts;
  const t = w.addText(String(text));
  t.font = bold ? Font.boldSystemFont(size) : Font.systemFont(size);
  t.lineLimit = lineLimit;
  if (centered) t.centerAlignText();
  if (color) t.textColor = color;
  return t;
}

// ----------------- Main -----------------
const lang = pickLangAuto();
const cfg = CFG[lang];

// fichiers cache par langue
const cacheItemsPath = p(`cacheItems_${lang}.json`); // [{num,title,author,updated,id,affairLink}]
const lastUpdatePath = p(`lastUpdate_${lang}.txt`);
const seenNumsPath = p(`seenNums_${lang}.json`);
const lastNewNumsPath = p(`lastNewNums_${lang}.json`);

let items = loadJSON(cacheItemsPath, []);
const lastUpdateISO = loadString(lastUpdatePath, "");

let didUpdate = false;
if (shouldUpdate(lastUpdateISO) || !items.length) {
  try {
    items = await fetchInterpellations(cfg);
    saveJSON(cacheItemsPath, items);
    saveString(lastUpdatePath, nowISO());
    didUpdate = true;
  } catch (e) {
    // garde le cache si fetch échoue
  }
}

// nouveautés vs "hier"
const numsNow = items.map((x) => x.num).filter(Boolean);
let newNumsToShow = loadJSON(lastNewNumsPath, []);

if (didUpdate) {
  const seen = loadJSON(seenNumsPath, []);
  const newNums = numsNow.filter((n) => !seen.includes(n));
  saveJSON(lastNewNumsPath, newNums);
  saveJSON(seenNumsPath, numsNow);
  newNumsToShow = newNums;
}

// 3 dernières
const last3 = items.slice(0, 3);

// Widget
const w = new ListWidget();
w.url = cfg.curiaUrl;
w.setPadding(6, 12, 12, 12);

addCenteredTitle(w, cfg.title);
w.addSpacer(6);

// Nouveautés
if (newNumsToShow && newNumsToShow.length > 0) {
  addLine(w, newNumsToShow.join(" / "), {
    bold: true,
    centered: true,
    size: 12,
    lineLimit: 1,
  });
} else {
  addLine(w, "❌", { bold: true, centered: true, size: 12 });
}

w.addSpacer(8);

// 3 dernières: num — titre + auteur
if (!last3.length) {
  addLine(w, "—", { size: 12 });
} else {
  for (const it of last3) {
    const header =
      it.num && it.title
        ? `${it.num} — ${clamp(it.title, 60)}`
        : it.num || clamp(it.title, 60) || "—";
    addLine(w, header, { bold: true, size: 11, lineLimit: 1 });

    if (it.author) {
      addLine(w, clamp(it.author, 40), {
        size: 10,
        color: Color.gray(),
        lineLimit: 1,
      });
    }

    w.addSpacer(4);
  }
}

Script.setWidget(w);
Script.complete();